\chapter{Methodology and validation}
\section{Simulation tool and data processing}
Taken as a tool, the direct numerical simulation program \texttt{streamlinesnt3D}, written in \textsc{FORTRAN} by \citet{Meyer2017}, is the angular stone of this work's methodology. 
Briefly, the program must be fed with a voxel mesh representing the solid regions as well as an Eulerian velocity field corresponding to a numerical solution of the Stokes equation \eqref{eq:stokes} computed beforehand.
The studied voxel meshes have been obtained from the Digital Rocks Portal website (\citet{digitalrocksportal}) and the Eulerian flow were computed for a unitary pressure gradient as boundary condition.\\
\texttt{streamlinesnt3D} can run in two different modes.
The first mode simulates the evolution of a single particle during a user provided time $T_{max}$ or until the particle completed a certain number of passage through the sample denoted by SLSM (stream line section max). 
The particle position and velocity are sampled given a user provided cell storage frequency (CSF) where $\mathrm{CSF}=N$ will sample the particle state every $N$ time steps.\\
The second mode is meant to track simultaneously $N_p$ particles forming a plume. The output data are snapshots regarding a user provided timetable. 
In opposite to the single particle tracker, this mode does not allow to display trajectories but is more efficient to evaluate macroscopic mass transport since it can run in parallel with OpenMP.

Finally, both program modes use the same tracking method that interpolates the displacement of a particle from a face to another taking advection and diffusion into account.
On one hand, advection is simulated by determining, with a linear approximation of the velocity gradient, which next cell face a particle will reach and how long it will take (c.f. \cite{Pollock1988}).
On the other hand, diffusive behavior has been modeled as a probability for the particle to deviate from the velocity field in a random direction with a velocity magnitude related to the molecular diffusion $D_m$ (c.f. \citet{Meyer2017}).\\
The key of combining advection and diffusion in this algorithm resides in setting the computation time step as the minimum between the advection only time step $dt_A$ from \citet{Pollock1988} and a diffusive time step $dt_\zeta:=2\times\frac{L_c^2}{D_m}$ with $L_c$ the cell length.
Thus, a large diffusion coefficient will lead to a small diffusive time step 

As well as every classical Eulerian CFD numerical scheme, the program must fulfill the Courant–Friedrichs–Lewy (CFL) condition \eqref{eq:CFL} in order to be stable. 
\begin{equation}
	\Delta t < C\frac{\textbf{u}_i\cdot \hat{\textbf{x}}_d}{\Delta x} \quad \forall i\in\{1,2,...,N_p\},\,\forall \quad \hat{\textbf{x}}_1\in\{\hat{\textbf{x}}_2,\hat{\textbf{x}}_3,\hat{\textbf{x}}_d\}.
	\label{eq:CFL}
\end{equation}
In order to minimize the computation time, the program set the time step to the maximal value that fulfills the CFL condition for the current particle state. 
The sampled data form thus an heterogeneous time series that should be post processed in order to obtain results that can be compared to \citet{Meyer2016}.

\begin{algorithm}
	\caption{Isochronous transform post processing pseudo-code }
	\label{alg:isochronous}
	\begin{algorithmic}
		\State \textbf{Input :} $\{(t_i,v_i)\}_{i=1}^N$
		\Comment{Heterogeneous time series}
		\State \textbf{Output :} $\{(\hat{t}_j,\hat{v}_j)\}_{j=1}^{\hat{N}}$
		\Comment{Isochronous time series}
		\State $\hat{\Delta t} \gets \frac{1}{N}\sum_{n=0}^{N-1}(t_{n+1}-t_{n})$
		\Comment{Mean DNS time step}
		\State $n \gets 1$, $j \gets 1$, $\hat{t} \gets t_1$
		\Comment{Temporal loop initialization}
		\While {$n \leq N$}
		\While {$t_n <= \hat{t} <= t_{n+1}$}
		\State $\hat{v}_j \gets v_n + \frac{\hat{t}-t_n}{t_{n+1}-t_n} v_{n+1}$
		\State $\hat{t}\gets \hat{t} + \hat{\Delta t}$
		\State $j \gets j + 1$
		\EndWhile
		\State $n\gets n+1$
		\EndWhile
	\end{algorithmic}
\end{algorithm}

Hence, a post processing treatment has been implemented in \textsc{Python} using \textsc{Scipy} packages to transform the output of the program, denoted DNS, into the isochronous time series needed for the statistical analysis.
Algorithm \ref{alg:isochronous} shows the method used to perform the isochronous transformation of the DNS data which consists in using equidistantly linear interpolation.
It is worth noting that the average DNS time step has been chosen as the equidistant time interval since it enables to keep the size of the resulting isochronous series comparable to the original one.\\
\begin{figure}
	\centering
	\includegraphics[scale=0.8]{Figures/check_iso_transf.pdf}
	\caption{Example of isochronous transform for $100$ DNS points in the Bentheimer 1000 sample. As a reminder, the log velocity magnitude is denoted $v=\ln{(u/U)}$ where $u:=||\textbf{u}||_2$ is the Lagrangian velocity magnitude}
	\label{fig:checkisotransf}
\end{figure}
Figure \ref{fig:checkisotransf} displays the results of Algorithm \ref{alg:isochronous} for three independent simulations.
It can be observed that the highest frequencies of the data cannot be sampled by the isochronous series (see Nyquist–Shannon sampling theorem) which makes this process similar to a low pass filter in signal processing.
Fortunately, the statistics of interest should not be affected by such loss of information. 
It could be however more problematic in a Fourier analysis of the data.\\

A similar version of Algorithm \ref{alg:isochronous} has also been used to compute equidistant time series as for the directional angle, $\theta_n:=\theta(l_n)\in[-\pi,\pi]$ where $l_n = l_{n-1} + ||\textbf{u}_n||_2 \Delta t$.
More precisely, the angle $\theta$ indicates the orientation of the particle velocity vector, $\textbf{u}_n :=\textbf{u}(t_n)$, with respect to the mean flow direction $\textbf{U}$ (see Figure \ref{fig:anglemeasuring}). 
Similarly to \citet{Meyer2016}, it is geometrically defined as
\begin{equation}
\cos \theta_n = S_{n} \frac{\textbf{u}_n}{||\textbf{u}_n||_2 }\cdot \frac{\textbf{U}}{||\textbf{U}||_2},
\end{equation}
where $S_{n,n-1}\in\{-1,1\}$ is a factor that changes its sign if the velocity direction went across the plane spanned by $\textbf{U}$ and $\textbf{U}\cross\textbf{u}_{n-1}$ on the previous step as shown in detail on Figure \ref{fig:anglemeasuring}), i.e.
\begin{equation}
S_{n} = \mathrm{sign}_+(\textbf{u}_n\cdot [(\textbf{U}\cross\textbf{u}_{n-1})\cross \textbf{U}])\cdot S_{n-1} 
\end{equation}
with sign$_+(x\geq 0)=1$ and sign$_+(x< 0)=-1$.

To complete the description of the trajectory in Lagrangian referential, a second angle $\beta(l)$ is introduced. In practice, it is computed using increments $\Delta \beta_n$ measured as the orientation change of the orthogonal vector $\textbf{U}\cross \textbf{u}$ between two consecutive steps, i.e.
\begin{equation}
\cos\Delta\beta_n = \frac{[\textbf{U}\cross \textbf{u}_{n+1}]}{||\textbf{U}\cross \textbf{u}_{n+1}||_2}
\cdot
\frac{[\textbf{U}\cross \textbf{u}_{n}]}{||\textbf{U}\cross \textbf{u}_n||_2}
\end{equation}

\begin{figure}
	\centering
	\includegraphics[width=0.4\linewidth]{Figures/angle_measuring}
	\caption{Illustration of the directional angle $\theta$. In the case where $\textbf{u}_{n+1} = \textbf{u}_a$, $S_{n+1}$ is positive since $\textbf{u}_a$ sits on the same side of the plane $\hat{n}$ as $\textbf{u}_n$. Inversely, if $\textbf{u}_{n+1} = \textbf{u}_b$, $\theta_{n+1}$ sign is opposed to $\theta_n$ sign. }
	\label{fig:anglemeasuring}
\end{figure}


\section{Validation of \cite{Meyer2016} results for advection dominated regime $(\mathrm{Pe}=\infty)$}
In order to validate the post processing methodology, the main results of \cite{Meyer2016} have been reproduced by running \texttt{streamlinesnt3D} on the ETH Euler cluster (scicomp.ethz.ch/wiki/Euler) without molecular diffusion ($D_m=0$ or $\mathrm{Pe}=\infty$).\\ 

In the case of global transport behavior, the plume tracking results at early time have been reproduced as shown on Figure \ref{fig:plume_peinf}. 
Similarly to \cite{Meyer2016}, one can observe that, despite the main tendency to move along the mean flow direction, some back flow ($x_1<0$) appears at $t=10^-2T$ and $t=10^0T$. 
At larger time ($t=10^2T$), this stagnancy leads to a separation of the plume in two groups : one with fast traveling particles that follows rapid streamlines, the other with slow moving particles that resides in the boundary layer of the solid domain.
This disparity is of course problematic regarding ergodicity when sampling DNS data.
For plume tracking, number of particle has been adjusted to be large enough to represents correctly the proportion between free and stuck particles.
In the case of single particle tracking, a maximum number of pathways across the sample has been set as simulation stopping criterium in order to prevents possible bias from the slow regions in single particle tracking simulations.
\textit{However, these solutions will be modified for finite Péclet regime as discussed further. }

\begin{figure}[h!]
	\centering
	\includegraphics[scale=0.8]{Figures/Plume_vs_markov_PeInf.pdf}
	\caption{Comparison between DNS results ($2\times 10^5$ particles, solid line) and Markov model ($10^5$ particles, dashed line) for plume displacement in average flow direction at $\mathrm{Pe}=\infty$. The DNS particles where placed randomly among the sample.}
	\label{fig:plume_peinf}
\end{figure}

In a microscopic point of view, Figure \ref{fig:lvm_pdf_peinf} displays the distribution of Lagrangian log velocity magnitude (LVM), $v = \ln[||\textbf{u}||_2/U]$. 
It is worth noting that, as expected, the PDF obtained from isochronous series differs drastically from the rough DNS data by its wider distribution and its slower mean velocity.
Hence, it illustrates the fact that DNS data contain a statistical bias leading to an underestimation of the small velocities due to the variable simulation time step, meant to accelerate the computation.\\
In the case of isochronous data, the PDF fits perfectly the sample Eulerian LVM distribution which can be seen as a good indicator of data ergodicity since it means that the sample velocity spectrum has been evenly visited.
Finally, the Markov process designed by \cite{Meyer2016} to model the LVM has been implemented in a \textsc{Python} script as well and fits perfectly the isochronous PDF.

\begin{figure}
	\centering
	\includegraphics[scale=0.8]{Figures/LVM_pdf_DM=0.pdf}
	\caption{Log velocity magnitude PDF for DNS and Isochronous data. The solid red line displays the skew normal probability distribution parametrized in \citet{Meyer2016} for Bentheimer 1000 sandstone The dashed gray line represents the Eulerian LVM PDF of the field among the sample. The particle has been tracked for $2\times 10^4$ passages with sampling at each time step.}
	\label{fig:lvm_pdf_peinf}
\end{figure}

As a last validation tool, the auto-correlation has been computed using an unbiased formula \eqref{eq:autocorr} for both LVM $v$ (Figure \ref{fig:autocorrv_peinf}) and directional angle $\theta$ (Figure \ref{fig:autocorrt_peinf}). 

It can be interesting to compare the auto-correlation of $\theta$ with its probability distribution on a polar plot. 
Indeed, even though a zero mean is measured in the values of $\theta$, its PDF appears to be split in two even area centered at $\theta\approx\pm\pi/4$ (cf. polar plot on Figure \ref{fig:autocorrt_peinf}).


\begin{equation}
\hat R(k) = \frac{1}{n-k} \sum_{t=1}^{n-k} \left(\frac{X_t-\mu_Y}{\sigma_X}\right)\left(\frac{Y_t-\mu_Y}{\sigma_Y}\right) \quad\textrm{where}\quad \{Y_1,Y_2,...,Y_{n-k}\} := \{X_{k+1},X_{k+2},...,X_{n}\} 
\label{eq:autocorr}
\end{equation}

\begin{figure}
	\centering
	\includegraphics[scale=0.8]{Figures/autocorr_theta_PeInf.pdf}
	\caption{Directional angle $\theta$ auto-correlation and its distribution on a polar representation. $\hat{R}_\theta(l)$ has been computed for $n=10^7$ points when $l_{max}\approx 4\times10^4 \Delta l$}
	\label{fig:autocorrt_peinf}
\end{figure}

\chapter{Advection diffusion regime ($\mathrm{Pe}<\infty$)}

\section{Plume tracking}
\begin{figure}[h!]
	\centering
	\includegraphics[scale=0.8]{Figures/model_test.pdf}
	\caption{Plume displacement for different Péclet values.}
	\label{fig:lvm_pdf_peinf}
\end{figure}

\section{Particle tracking}
In order to measure quantitatively the influence of the molecular diffusion coefficient, the log velocity magnitude distribution results showed at Figure \ref{fig:lvm_pdf_peinf} have been extended for finite Péclet values ($\mathrm{Pe}\in[10^{-1};10^3]$) leading to the results depicted by Figure \ref{fig:lvm_pdf_pe}.\\
At large Péclet number ($\mathrm{Pe}\approx 10^3$), one can observe that the LVM histogram is shifted to the left, almost joining the DNS data. 
This can be explained by the fact that a small amount of diffusion enables the particles to exit quicker slow regions and join the main, rapid streamlines.
Moreover, it is worth noting that this shift is not a statistical artifact, as for the DNS histogram, but a real modification of the particle dynamic.\\
For lower Péclet values ($\mathrm{Pe}\approx10^1$), the particles are more and more able to explore the velocity field independently from their speed, sampling again low velocity regions which makes the LVM distribution converges to the fully advective case.
In the end, both fully advective or diffusive regimes appear to lead to an homogeneous sampling of the Eulerian velocity spectrum.\\
This whole dynamic put in evidence the fact that, indeed, a small amount of molecular diffusion impeaches stagnation in low velocity region but it can also, at lower Péclet value, reroute fast traveling particles to slower streamlines.

In a more practical point of view, controlling the Péclet number could, thus, be a game changer in a numerous application. If the objective is the rapidity of the transport regardless its homogeneity, a finite, large Péclet value is preferable. On the other side, a low Péclet value can be useful in the case where the solute cannot be wasted or if it has to diffuse homogeneously in the environment.\\

It is worth noting that the diffusion coefficient affects the DNS distributions as well because of the structure of the particle tracking algorithm whose time step is defined as the minimum between a velocity dependent, advective time step and a constant, diffusive one.
At finite Péclet value, the diffusive time will often be smaller than the advective one, regardless the current velocity, leading to an isochronous time step simulation.\\
\begin{figure}[h!]
	\centering
	\includegraphics[scale=0.8]{Figures/LVM_pdf_comparison.pdf}
	\caption{Log velocity magnitude PDF for rough DNS data and isochronous data in different diffusion regimes. For advection-diffusion cases, the simulations were stopped after the same number of steps than the advective only regime ($\approx6\times 10^6$ steps) }
	\label{fig:lvm_pdf_pe}
\end{figure}
